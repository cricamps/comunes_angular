<!-- NAVEGACIÓN -->
<app-navbar></app-navbar>

<!-- CONTENIDO PRINCIPAL -->
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-cart3"></i> Pagar Cuotas Pendientes</h2>
        <button class="btn btn-secondary" (click)="volver()">
          <i class="bi bi-arrow-left"></i> Volver
        </button>
      </div>
    </div>
  </div>

  <!-- Información del usuario -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-info">
        <strong>{{ nombreUsuario }}</strong> - Casa {{ pasaje }}-{{ casa }}
      </div>
    </div>
  </div>

  <!-- Cuotas Disponibles -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Cuotas Pendientes de Pago</h5>
        </div>
        <div class="card-body">
          <div *ngIf="cuotasDisponibles.length === 0" class="alert alert-success">
            <i class="bi bi-check-circle"></i> ¡No tienes cuotas pendientes! Estás al día.
          </div>

          <div *ngIf="cuotasDisponibles.length > 0" class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Mes</th>
                  <th>Año</th>
                  <th>Monto</th>
                  <th>Vencimiento</th>
                  <th>Estado</th>
                  <th class="text-center">Acción</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let cuota of cuotasDisponibles">
                  <td><strong>{{ cuota.mes }}</strong></td>
                  <td>{{ cuota.anio }}</td>
                  <td class="text-success"><strong>${{ cuota.monto.toLocaleString() }}</strong></td>
                  <td>{{ cuota.fechaVencimiento | date:'dd/MM/yyyy' }}</td>
                  <td>
                    <span [class]="obtenerClaseEstado(cuota)">
                      {{ cuota.estado === 'pendiente' ? 'Pendiente' : 'Vencida' }}
                    </span>
                  </td>
                  <td class="text-center">
                    <button 
                      *ngIf="!estaEnCarrito(cuota.id)"
                      class="btn btn-sm btn-success"
                      (click)="agregarAlCarrito(cuota)">
                      <i class="bi bi-cart-plus"></i> Agregar
                    </button>
                    <button 
                      *ngIf="estaEnCarrito(cuota.id)"
                      class="btn btn-sm btn-danger"
                      (click)="eliminarDelCarrito(cuota.id)">
                      <i class="bi bi-cart-dash"></i> Quitar
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Carrito de Pago -->
  <div class="row" *ngIf="items.length > 0">
    <div class="col-12">
      <div class="card border-success">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-cart-check"></i> 
            Carrito de Pago ({{ items.length }} cuota<span *ngIf="items.length > 1">s</span>)
          </h5>
        </div>
        <div class="card-body">
          <!-- Botones de selección masiva -->
          <div class="mb-3">
            <button class="btn btn-sm btn-outline-primary me-2" (click)="seleccionarTodas()">
              <i class="bi bi-check-all"></i> Seleccionar Todas
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" (click)="deseleccionarTodas()">
              <i class="bi bi-x-square"></i> Deseleccionar Todas
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="vaciarCarrito()">
              <i class="bi bi-trash"></i> Vaciar Carrito
            </button>
          </div>

          <!-- Tabla del carrito -->
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th width="50px">
                    <input 
                      type="checkbox" 
                      class="form-check-input"
                      [checked]="cantidadSeleccionados === items.length && items.length > 0"
                      (change)="cantidadSeleccionados === items.length ? deseleccionarTodas() : seleccionarTodas()">
                  </th>
                  <th>Mes</th>
                  <th>Año</th>
                  <th>Monto</th>
                  <th>Estado</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of items" [class.table-active]="item.seleccionada">
                  <td>
                    <input 
                      type="checkbox" 
                      class="form-check-input"
                      [checked]="item.seleccionada"
                      (change)="toggleSeleccion(item.cuota.id)">
                  </td>
                  <td>
                    <strong>{{ item.cuota.mes }}</strong>
                  </td>
                  <td>{{ item.cuota.anio }}</td>
                  <td>
                    <span class="text-success fw-bold">
                      ${{ item.cuota.monto.toLocaleString() }}
                    </span>
                  </td>
                  <td>
                    <span [class]="obtenerClaseEstado(item.cuota)">
                      {{ item.cuota.estado === 'pendiente' ? 'Pendiente' : 'Vencida' }}
                    </span>
                  </td>
                  <td class="text-center">
                    <button 
                      class="btn btn-sm btn-danger"
                      (click)="eliminarDelCarrito(item.cuota.id)"
                      title="Eliminar del carrito">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="table-info">
                  <td colspan="3" class="text-end"><strong>Cuotas Seleccionadas:</strong></td>
                  <td colspan="3"><strong>{{ cantidadSeleccionados }}</strong></td>
                </tr>
                <tr class="table-success">
                  <td colspan="3" class="text-end"><h5 class="mb-0"><strong>TOTAL A PAGAR:</strong></h5></td>
                  <td colspan="3"><h4 class="mb-0 text-success"><strong>${{ total.toLocaleString() }}</strong></h4></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Botón de pago -->
          <div class="mt-4 text-end">
            <button 
              class="btn btn-lg btn-success"
              [disabled]="cantidadSeleccionados === 0 || procesandoPago"
              (click)="procesarPago()">
              <i class="bi bi-credit-card"></i>
              <span *ngIf="!procesandoPago">
                Pagar {{ cantidadSeleccionados }} Cuota<span *ngIf="cantidadSeleccionados > 1">s</span>
                (${{ total.toLocaleString() }})
              </span>
              <span *ngIf="procesandoPago">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Procesando pago...
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensaje cuando el carrito está vacío -->
  <div class="row" *ngIf="items.length === 0 && cuotasDisponibles.length > 0">
    <div class="col-12">
      <div class="alert alert-warning">
        <i class="bi bi-cart-x"></i> 
        <strong>Tu carrito está vacío.</strong> 
        Agrega las cuotas que deseas pagar usando el botón "Agregar" en la tabla de arriba.
      </div>
    </div>
  </div>
</div>
