<!-- Navbar -->
<app-navbar></app-navbar>

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-3">
        <i class="bi bi-graph-up-arrow me-2"></i>
        Estadísticas de Gastos Comunes
      </h2>
      <p class="text-muted">Análisis detallado de los gastos y pagos de la comunidad</p>
    </div>
  </div>

  <!-- Mensaje de carga -->
  <div *ngIf="cargando" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3">Cargando estadísticas...</p>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="error && !cargando" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ error }}
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!cargando && !error">
    
    <!-- Tarjetas de resumen -->
    <div class="row g-4 mb-4">
      <!-- Total Mensual -->
      <div class="col-md-6 col-lg-3">
        <div class="card border-primary h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Gasto Mensual</h6>
                <h3 class="mb-0">${{ totalMensualConceptos | number:'1.0-0' }}</h3>
                <small class="text-muted">por casa</small>
              </div>
              <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                <i class="bi bi-cash-coin text-primary fs-4"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Recaudado -->
      <div class="col-md-6 col-lg-3">
        <div class="card border-success h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Total Recaudado</h6>
                <h3 class="mb-0">${{ totalRecaudado | number:'1.0-0' }}</h3>
                <small class="text-success">{{ getPorcentajePagos() | number:'1.0-0' }}% de pagos</small>
              </div>
              <div class="bg-success bg-opacity-10 rounded-circle p-3">
                <i class="bi bi-check-circle text-success fs-4"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Pendiente -->
      <div class="col-md-6 col-lg-3">
        <div class="card border-warning h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Pendiente</h6>
                <h3 class="mb-0">${{ totalPendiente | number:'1.0-0' }}</h3>
                <small class="text-warning">{{ pagosPendientes.length }} pagos pendientes</small>
              </div>
              <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                <i class="bi bi-clock-history text-warning fs-4"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Promedio por Habitante -->
      <div class="col-md-6 col-lg-3">
        <div class="card border-info h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted mb-2">Por Habitante</h6>
                <h3 class="mb-0">${{ getPromedioPorHabitante() | number:'1.0-0' }}</h3>
                <small class="text-muted">{{ totalHabitantes }} habitantes</small>
              </div>
              <div class="bg-info bg-opacity-10 rounded-circle p-3">
                <i class="bi bi-people text-info fs-4"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Distribución por Categoría -->
    <div class="row g-4 mb-4">
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-pie-chart-fill me-2"></i>
              Distribución de Gastos por Categoría
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6" *ngFor="let categoria of getCategoriasArray()">
                <div class="d-flex justify-content-between mb-2">
                  <span class="fw-medium">{{ categoria }}</span>
                  <span class="text-muted">${{ gastosPorCategoria[categoria] | number:'1.0-0' }}</span>
                </div>
                <div class="progress" style="height: 20px;">
                  <div 
                    class="progress-bar" 
                    [class.bg-primary]="getPorcentajeCategoria(categoria) >= 30"
                    [class.bg-info]="getPorcentajeCategoria(categoria) >= 20 && getPorcentajeCategoria(categoria) < 30"
                    [class.bg-secondary]="getPorcentajeCategoria(categoria) < 20"
                    [style.width.%]="getPorcentajeCategoria(categoria)"
                    role="progressbar">
                    {{ getPorcentajeCategoria(categoria) | number:'1.0-0' }}%
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Conceptos Activos -->
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-list-check me-2"></i>
              Conceptos de Gasto
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Conceptos Activos:</span>
                <span class="badge bg-success">{{ conceptosActivos.length }}</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <span>Total Conceptos:</span>
                <span class="badge bg-secondary">{{ conceptosGastos.length }}</span>
              </div>
            </div>
            <hr>
            <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
              <div class="list-group-item px-0" *ngFor="let concepto of conceptosActivos">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <small class="d-block fw-medium">{{ concepto.nombre }}</small>
                    <small class="text-muted">{{ traducirCategoria(concepto.categoria) }}</small>
                  </div>
                  <span class="badge bg-light text-dark">
                    ${{ concepto.montoPorDefecto | number:'1.0-0' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estado de Pagos -->
    <div class="row g-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-clipboard-check me-2"></i>
              Estado de Pagos
            </h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-4">
                <h6 class="text-muted">Total de Pagos</h6>
                <h2>{{ pagosHistoricos.length }}</h2>
              </div>
              <div class="col-md-4">
                <h6 class="text-success">Pagos Completados</h6>
                <h2>{{ pagosHistoricos.length - pagosPendientes.length }}</h2>
              </div>
              <div class="col-md-4">
                <h6 class="text-warning">Pagos Pendientes</h6>
                <h2>{{ pagosPendientes.length }}</h2>
              </div>
            </div>
            <div class="mt-4">
              <div class="progress" style="height: 30px;">
                <div 
                  class="progress-bar"
                  [ngClass]="getBadgeClass(getPorcentajePagos())"
                  [style.width.%]="getPorcentajePagos()"
                  role="progressbar">
                  {{ getPorcentajePagos() | number:'1.1-1' }}% Completado
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
