<!-- NAVEGACIÓN -->
<app-navbar></app-navbar>

<!-- CONTENIDO PRINCIPAL -->
<main class="container-fluid my-4">
    <!-- HEADER -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="mb-2 mb-md-0">
                    <h1 class="fw-bold mb-0">Gestionar Residentes</h1>
                    <p class="text-muted mb-0">Administra los residentes de la comunidad - Soporte para múltiples residentes por casa</p>
                </div>
                <button class="btn btn-primary" (click)="abrirModalNuevo()">
                    <i class="bi bi-person-plus"></i> Nuevo Residente
                </button>
            </div>
        </div>
    </div>

    <!-- ESTADÍSTICAS -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card primary border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-primary text-white me-3">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Total Residentes</h6>
                        <h2 class="fw-bold mb-0">{{ estadisticas.totalResidentes }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card success border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-success text-white me-3">
                        <i class="bi bi-house-fill"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Casas Ocupadas</h6>
                        <h2 class="fw-bold mb-0">{{ estadisticas.casasOcupadas }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card warning border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-warning text-white me-3">
                        <i class="bi bi-house-door"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Casas Disponibles</h6>
                        <h2 class="fw-bold mb-0">{{ estadisticas.casasDisponibles }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stat-card info border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-info text-white me-3">
                        <i class="bi bi-percent"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Ocupación</h6>
                        <h2 class="fw-bold mb-0">{{ estadisticas.porcentajeOcupacion }}%</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTROS -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-5">
                    <label class="form-label fw-bold">
                        <i class="bi bi-search"></i> Buscar
                    </label>
                    <input type="text" 
                           class="form-control" 
                           [(ngModel)]="busqueda"
                           (ngModelChange)="aplicarFiltros()"
                           placeholder="Buscar por nombre, RUT o email...">
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-geo-alt"></i> Pasaje
                    </label>
                    <select class="form-select" 
                            [(ngModel)]="filtroPasaje"
                            (ngModelChange)="onFiltroPasajeChange()">
                        <option value="">Todos los pasajes</option>
                        <option value="8651">Pasaje 8651</option>
                        <option value="8707">Pasaje 8707</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label fw-bold">
                        <i class="bi bi-house-door"></i> Casa
                    </label>
                    <select class="form-select" 
                            [(ngModel)]="filtroCasa"
                            (ngModelChange)="aplicarFiltros()">
                        <option value="">Todas</option>
                        <option *ngFor="let casa of casasFiltro" [value]="casa">Casa {{ casa }}</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label fw-bold d-block">&nbsp;</label>
                    <button class="btn btn-secondary w-100" (click)="limpiarFiltros()">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA DE RESIDENTES -->
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class="bi bi-list-ul"></i> Lista de Residentes
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>RUT</th>
                            <th>Edad</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Vivienda</th>
                            <th>Parentesco</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="residentesFiltrados.length === 0">
                            <td colspan="8" class="text-center text-muted py-5">
                                <i class="bi bi-inbox fs-3"></i>
                                <p class="mt-3 mb-0">No hay residentes registrados</p>
                                <button class="btn btn-primary mt-3" (click)="abrirModalNuevo()">
                                    <i class="bi bi-person-plus"></i> Agregar Primer Residente
                                </button>
                            </td>
                        </tr>
                        <tr *ngFor="let residente of residentesFiltrados" class="fade-in">
                            <td>
                                <strong>{{ residente.nombre }}</strong>
                                <i *ngIf="residente.esTitular" class="bi bi-star-fill text-warning ms-1" title="Titular de la casa"></i>
                                <span *ngIf="residente.rol === 'administrador'" class="badge bg-danger ms-1">
                                    <i class="bi bi-shield-check"></i> Admin
                                </span>
                            </td>
                            <td>{{ residente.rut }}</td>
                            <td>{{ obtenerEdad(residente) }} años</td>
                            <td>{{ residente.email }}</td>
                            <td>+56 {{ residente.telefono }}</td>
                            <td>
                                <span class="badge bg-secondary">
                                    {{ residente.pasaje }}-{{ residente.casa }}
                                </span>
                                <span *ngIf="contarResidentesEnCasa(residente.pasaje, residente.casa) > 1" 
                                      class="badge bg-secondary ms-1"
                                      [title]="contarResidentesEnCasa(residente.pasaje, residente.casa) + ' personas en esta casa'">
                                    {{ contarResidentesEnCasa(residente.pasaje, residente.casa) }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-info">
                                    {{ obtenerParentescoTexto(residente.parentesco) }}
                                </span>
                            </td>
                            <td class="text-nowrap">
                                <button class="btn btn-sm btn-info" (click)="verResidente(residente)" title="Ver detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" (click)="abrirModalEditar(residente)" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" (click)="abrirModalEliminar(residente)" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- MODAL NUEVO/EDITAR RESIDENTE -->
<div class="modal fade" [class.show]="mostrarModal" [style.display]="mostrarModal ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> {{ tituloModal }}
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
            </div>
            <div class="modal-body">
                <!-- ALERTA DE INFORMACIÓN -->
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle"></i> <strong>Información importante:</strong>
                    <ul class="mb-0 mt-2 small">
                        <li>Solo pueden registrarse personas <strong>mayores de 18 años</strong></li>
                        <li>Cada casa puede tener hasta <strong>10 residentes</strong> registrados</li>
                        <li>El <strong>titular</strong> es el responsable principal ante la administración</li>
                    </ul>
                </div>
                
                <div class="row">
                    <!-- COLUMNA 1: DATOS PERSONALES -->
                    <div class="col-md-6">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="bi bi-person-badge"></i> Datos Personales
                        </h6>
                        
                        <div class="mb-3">
                            <label for="nombre" class="form-label fw-bold">
                                <i class="bi bi-person"></i> Nombre Completo *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   [(ngModel)]="residenteForm.nombre"
                                   placeholder="Ej: Juan Pérez González">
                        </div>

                        <div class="mb-3">
                            <label for="rut" class="form-label fw-bold">
                                <i class="bi bi-card-text"></i> RUT *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   [(ngModel)]="residenteForm.rut"
                                   (input)="formatearRUT($event)"
                                   maxlength="12"
                                   placeholder="12345678-9">
                        </div>

                        <div class="mb-3">
                            <label for="fechaNacimiento" class="form-label fw-bold">
                                <i class="bi bi-calendar-heart"></i> Fecha de Nacimiento *
                            </label>
                            <input type="date" 
                                   class="form-control" 
                                   [(ngModel)]="residenteForm.fechaNacimiento"
                                   max="2007-11-09">
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label fw-bold">
                                <i class="bi bi-envelope"></i> Email *
                            </label>
                            <input type="email" 
                                   class="form-control" 
                                   [(ngModel)]="residenteForm.email"
                                   placeholder="ejemplo@correo.com">
                        </div>

                        <div class="mb-3">
                            <label for="telefono" class="form-label fw-bold">
                                <i class="bi bi-phone"></i> Teléfono *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">+56</span>
                                <input type="tel" 
                                       class="form-control" 
                                       [(ngModel)]="residenteForm.telefono"
                                       maxlength="9"
                                       placeholder="912345678">
                            </div>
                        </div>
                    </div>

                    <!-- COLUMNA 2: DATOS DE VIVIENDA -->
                    <div class="col-md-6">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="bi bi-house-door"></i> Datos de Vivienda
                        </h6>
                        
                        <div class="mb-3">
                            <label for="pasaje" class="form-label fw-bold">
                                <i class="bi bi-geo-alt"></i> Pasaje *
                            </label>
                            <select class="form-select" 
                                    [(ngModel)]="residenteForm.pasaje"
                                    (ngModelChange)="onPasajeChange()">
                                <option value="">Seleccionar...</option>
                                <option value="8651">Pasaje 8651 (6 casas: A-F)</option>
                                <option value="8707">Pasaje 8707 (7 casas: A-G)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="casa" class="form-label fw-bold">
                                <i class="bi bi-house-door"></i> Casa *
                            </label>
                            <select class="form-select" 
                                    [(ngModel)]="residenteForm.casa"
                                    (ngModelChange)="onCasaChange()"
                                    [disabled]="!residenteForm.pasaje">
                                <option value="">{{ residenteForm.pasaje ? 'Selecciona casa' : 'Primero selecciona pasaje' }}</option>
                                <option *ngFor="let casa of casasDisponiblesModal" [value]="casa">Casa {{ casa }}</option>
                            </select>
                            <small *ngIf="residentesEnCasa.length > 0" class="text-info">
                                {{ residentesEnCasa.length }} residente(s) ya registrado(s)
                            </small>
                        </div>

                        <!-- INFORMACIÓN DE RESIDENTES EXISTENTES -->
                        <div *ngIf="residentesEnCasa.length > 0" class="mb-3">
                            <div class="alert alert-info">
                                <strong><i class="bi bi-people"></i> Residentes actuales en esta casa:</strong>
                                <ul class="mb-2 small mt-2">
                                    <li *ngFor="let r of residentesEnCasa">
                                        <strong>{{ r.nombre }}</strong>
                                        <span *ngIf="r.parentesco">({{ r.parentesco }})</span>
                                        <i *ngIf="r.esTitular" class="bi bi-star-fill text-warning" title="Titular principal"></i>
                                    </li>
                                </ul>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Capacidad: {{ residentesEnCasa.length }}/10 residentes
                                </small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="parentesco" class="form-label fw-bold">
                                <i class="bi bi-people"></i> Parentesco/Relación *
                            </label>
                            <select class="form-select" 
                                    [(ngModel)]="residenteForm.parentesco"
                                    (ngModelChange)="onParentescoChange()">
                                <option value="">Seleccionar...</option>
                                <option value="titular">Titular/Propietario</option>
                                <option value="conyuge">Cónyuge</option>
                                <option value="hijo">Hijo/Hija (mayor de 18)</option>
                                <option value="familiar">Otro Familiar</option>
                                <option value="arrendatario">Arrendatario</option>
                            </select>
                            <small class="text-muted">Relación con la vivienda</small>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       [(ngModel)]="residenteForm.esTitular"
                                       (ngModelChange)="onEsTitularChange()">
                                <label class="form-check-label fw-bold">
                                    <i class="bi bi-star-fill text-warning"></i> Marcar como titular principal de la casa
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-info-circle"></i> El titular es el responsable principal ante la administración.
                                Si ya existe un titular, este será reemplazado.
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="rol" class="form-label fw-bold">
                                <i class="bi bi-shield-check"></i> Rol del Usuario *
                            </label>
                            <select class="form-select" [(ngModel)]="residenteForm.rol">
                                <option value="residente">Residente</option>
                                <option value="administrador">Administrador</option>
                            </select>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Los administradores tienen acceso completo al sistema.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" (click)="guardarResidente()">
                    <i class="bi bi-check-circle"></i> Guardar Residente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- BACKDROP MODAL -->
<div class="modal-backdrop fade" [class.show]="mostrarModal || mostrarModalVer || mostrarModalEliminar" 
     *ngIf="mostrarModal || mostrarModalVer || mostrarModalEliminar"></div>

<!-- MODAL VER RESIDENTE -->
<div class="modal fade" [class.show]="mostrarModalVer" [style.display]="mostrarModalVer ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" *ngIf="residenteDetalle">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-badge"></i> Detalles del Residente
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="cerrarModalVer()"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary fw-bold mb-3"><i class="bi bi-person-badge"></i> Información Personal</h6>
                        <div class="mb-3">
                            <strong><i class="bi bi-person"></i> Nombre:</strong><br>
                            {{ residenteDetalle.nombre }}
                            <span *ngIf="residenteDetalle.esTitular" class="badge bg-warning ms-2">
                                <i class="bi bi-star-fill"></i> Titular Principal
                            </span>
                        </div>
                        <div class="mb-3">
                            <strong><i class="bi bi-card-text"></i> RUT:</strong><br>
                            {{ residenteDetalle.rut }}
                        </div>
                        <div class="mb-3">
                            <strong><i class="bi bi-calendar-heart"></i> Edad:</strong><br>
                            {{ obtenerEdad(residenteDetalle) }} años
                        </div>
                        <div class="mb-3">
                            <strong><i class="bi bi-envelope"></i> Email:</strong><br>
                            {{ residenteDetalle.email }}
                        </div>
                        <div class="mb-3">
                            <strong><i class="bi bi-phone"></i> Teléfono:</strong><br>
                            +56 {{ residenteDetalle.telefono }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary fw-bold mb-3"><i class="bi bi-house-door"></i> Información de Vivienda</h6>
                        <div class="mb-3">
                            <strong><i class="bi bi-geo-alt"></i> Dirección:</strong><br>
                            Pasaje {{ residenteDetalle.pasaje }}, Casa {{ residenteDetalle.casa }}
                        </div>
                        <div class="mb-3">
                            <strong><i class="bi bi-people"></i> Parentesco:</strong><br>
                            <span class="badge bg-info">{{ obtenerParentescoTexto(residenteDetalle.parentesco) }}</span>
                        </div>
                        <div class="mb-3">
                            <strong><i class="bi bi-shield-check"></i> Rol:</strong><br>
                            <span class="badge" [class.bg-danger]="residenteDetalle.rol === 'administrador'" [class.bg-primary]="residenteDetalle.rol !== 'administrador'">
                                {{ residenteDetalle.rol === 'administrador' ? 'Administrador' : 'Residente' }}
                            </span>
                        </div>
                        
                        <div *ngIf="otrosResidentesEnCasaDetalle.length > 0" class="alert alert-info mb-0">
                            <strong><i class="bi bi-people-fill"></i> Otros residentes en esta casa ({{ otrosResidentesEnCasaDetalle.length }}):</strong>
                            <ul class="mb-0 mt-2">
                                <li *ngFor="let r of otrosResidentesEnCasaDetalle">
                                    {{ r.nombre }}
                                    <span *ngIf="r.parentesco">({{ r.parentesco }})</span>
                                    <i *ngIf="r.esTitular" class="bi bi-star-fill text-warning" title="Titular principal"></i>
                                </li>
                            </ul>
                        </div>
                        
                        <div *ngIf="otrosResidentesEnCasaDetalle.length === 0" class="alert alert-success mb-0">
                            <i class="bi bi-house-check"></i> Único residente en esta casa
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cerrarModalVer()">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ELIMINAR -->
<div class="modal fade" [class.show]="mostrarModalEliminar" [style.display]="mostrarModalEliminar ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" *ngIf="residenteEliminar">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="cerrarModalEliminar()"></button>
            </div>
            <div class="modal-body">
                <p><strong>¿Estás seguro de eliminar este residente?</strong></p>
                <p class="text-muted mb-0">{{ residenteEliminar.nombre }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cerrarModalEliminar()">Cancelar</button>
                <button type="button" class="btn btn-danger" (click)="confirmarEliminar()">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
