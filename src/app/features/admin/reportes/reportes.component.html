<app-navbar></app-navbar>

<main class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="fw-bold mb-0">Reportes y Estadísticas</h1>
            <p class="text-muted mb-0">Genera reportes detallados de la comunidad - {{ mesActual }}</p>
        </div>
    </div>

    <!-- GENERADORES DE REPORTES -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100 hover-card" 
                 style="cursor: pointer;" 
                 (click)="verReporte('gastos')">
                <div class="card-body text-center p-4">
                    <i class="bi bi-receipt-cutoff fs-1 text-primary mb-3"></i>
                    <h5 class="fw-bold">Reporte de Gastos</h5>
                    <p class="text-muted mb-0">Gastos activos</p>
                    <small class="text-primary">
                        <i class="bi bi-eye"></i> Click para vista previa
                    </small>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100 hover-card" 
                 style="cursor: pointer;" 
                 (click)="verReporte('pagos')">
                <div class="card-body text-center p-4">
                    <i class="bi bi-cash-stack fs-1 text-success mb-3"></i>
                    <h5 class="fw-bold">Reporte de Pagos</h5>
                    <p class="text-muted mb-0">Pagos realizados</p>
                    <small class="text-success">
                        <i class="bi bi-eye"></i> Click para vista previa
                    </small>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100 hover-card" 
                 style="cursor: pointer;" 
                 (click)="verReporte('residentes')">
                <div class="card-body text-center p-4">
                    <i class="bi bi-people-fill fs-1 text-info mb-3"></i>
                    <h5 class="fw-bold">Lista de Residentes</h5>
                    <p class="text-muted mb-0">Todos los residentes</p>
                    <small class="text-info">
                        <i class="bi bi-eye"></i> Click para vista previa
                    </small>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100 hover-card" 
                 style="cursor: pointer;" 
                 (click)="verReporte('general')">
                <div class="card-body text-center p-4">
                    <i class="bi bi-clipboard-data fs-1 text-warning mb-3"></i>
                    <h5 class="fw-bold">Reporte General</h5>
                    <p class="text-muted mb-0">Resumen completo</p>
                    <small class="text-warning">
                        <i class="bi bi-eye"></i> Click para vista previa
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- RESUMEN DE DATOS -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Resumen Financiero</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <span><strong>Total Gastos Activos:</strong></span>
                            <span class="text-danger fw-bold">${{ resumen.totalGastos | number:'1.0-0' }}</span>
                        </div>
                    </div>
                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <span><strong>Total Recaudado ({{ mesActual }}):</strong></span>
                            <span class="text-success fw-bold">${{ resumen.totalRecaudado | number:'1.0-0' }}</span>
                        </div>
                    </div>
                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <span><strong>Pendiente por Cobrar:</strong></span>
                            <span class="text-warning fw-bold">${{ resumen.pendiente | number:'1.0-0' }}</span>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between">
                            <span><strong>Balance:</strong></span>
                            <span class="fw-bold" [ngClass]="getBalanceClase()">${{ resumen.balance | number:'1.0-0' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Estadísticas</h5>
                </div>
                <div class="card-body">
                    <!-- TASA DE PAGO -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>Tasa de Pago</strong></span>
                            <span class="fw-bold">{{ estadisticas.tasaPago }}%</span>
                        </div>
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar bg-success" 
                                 [style.width.%]="estadisticas.tasaPago">
                                {{ estadisticas.tasaPago }}%
                            </div>
                        </div>
                    </div>

                    <!-- CASAS AL DÍA -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>Casas al Día</strong></span>
                            <span class="fw-bold">{{ estadisticas.casasAlDia }} de 13</span>
                        </div>
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar bg-info" 
                                 [style.width.%]="(estadisticas.casasAlDia / 13) * 100">
                                {{ estadisticas.casasAlDia }} casas
                            </div>
                        </div>
                    </div>

                    <!-- RESIDENTES ACTIVOS -->
                    <div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>Residentes Activos</strong></span>
                            <span class="fw-bold">{{ estadisticas.totalResidentes }}</span>
                        </div>
                        <small class="text-muted">
                            Promedio: {{ (estadisticas.totalResidentes / 13).toFixed(1) }} residentes por casa
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁREA DE VISTA PREVIA -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-eye"></i> Vista Previa del Reporte</h5>
                    <button class="btn btn-primary" 
                            *ngIf="reporteActual"
                            (click)="imprimirReporte()">
                        <i class="bi bi-printer"></i> Imprimir
                    </button>
                </div>
                <div class="card-body">
                    <div *ngIf="!reporteActual" class="text-center text-muted py-5">
                        <i class="bi bi-file-earmark-text fs-1"></i>
                        <p class="mt-3">Selecciona un reporte arriba para ver la vista previa</p>
                    </div>

                    <!-- REPORTE DE GASTOS -->
                    <div *ngIf="reporteActual === 'gastos'" id="reporte-gastos">
                        <h3 class="mb-4">Reporte de Gastos Activos - {{ mesActual }}</h3>
                        
                        <div *ngIf="gastosActivos.length === 0" class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No hay gastos activos registrados.
                        </div>
                        
                        <table class="table table-striped table-hover" *ngIf="gastosActivos.length > 0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Concepto</th>
                                    <th>Descripción</th>
                                    <th>Categoría</th>
                                    <th>Estado</th>
                                    <th class="text-end">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let gasto of gastosActivos">
                                    <td class="fw-bold">{{ gasto.concepto }}</td>
                                    <td>{{ gasto.descripcion }}</td>
                                    <td><span class="badge bg-primary">{{ gasto.categoria }}</span></td>
                                    <td><span [ngClass]="getEstadoClase(gasto.estado)">{{ gasto.estado }}</span></td>
                                    <td class="text-end fw-bold">${{ gasto.monto | number:'1.0-0' }}</td>
                                </tr>
                                <tr class="table-warning">
                                    <td colspan="4" class="fw-bold text-end">TOTAL GASTOS ACTIVOS</td>
                                    <td class="text-end fw-bold">${{ resumen.totalGastos | number:'1.0-0' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- REPORTE DE PAGOS -->
                    <div *ngIf="reporteActual === 'pagos'" id="reporte-pagos">
                        <h3 class="mb-4">Reporte de Pagos - {{ mesActual }}</h3>
                        
                        <div *ngIf="pagosMesActual.length === 0" class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No hay pagos registrados para este mes.
                        </div>
                        
                        <table class="table table-striped table-hover" *ngIf="pagosMesActual.length > 0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Residente</th>
                                    <th>Casa</th>
                                    <th>Fecha Pago</th>
                                    <th>Método</th>
                                    <th class="text-end">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let pago of pagosMesActual">
                                    <td>{{ pago.nombreResidente }}</td>
                                    <td><span class="badge bg-secondary">{{ pago.pasaje }}-{{ pago.casa }}</span></td>
                                    <td>{{ pago.fecha | date:'dd/MM/yyyy' }}</td>
                                    <td><span class="badge bg-info">{{ pago.metodoPago }}</span></td>
                                    <td class="text-end fw-bold">${{ pago.monto | number:'1.0-0' }}</td>
                                </tr>
                                <tr class="table-success">
                                    <td colspan="4" class="fw-bold text-end">TOTAL RECAUDADO</td>
                                    <td class="text-end fw-bold">${{ resumen.totalRecaudado | number:'1.0-0' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- LISTA DE RESIDENTES -->
                    <div *ngIf="reporteActual === 'residentes'" id="reporte-residentes">
                        <h3 class="mb-4">Lista de Residentes Activos</h3>
                        
                        <div *ngIf="residentes.length === 0" class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No hay residentes registrados.
                        </div>
                        
                        <table class="table table-striped table-hover" *ngIf="residentes.length > 0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nombre</th>
                                    <th>RUT</th>
                                    <th>Casa</th>
                                    <th>Email</th>
                                    <th>Teléfono</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let residente of residentes">
                                    <td>{{ residente.nombre }}</td>
                                    <td>{{ residente.rut }}</td>
                                    <td><span class="badge bg-secondary">{{ residente.pasaje }}-{{ residente.casa }}</span></td>
                                    <td>{{ residente.email }}</td>
                                    <td>+56 {{ residente.telefono }}</td>
                                </tr>
                            </tbody>
                        </table>
                        <p class="text-muted mt-3">Total de residentes: <strong>{{ residentes.length }}</strong></p>
                    </div>

                    <!-- REPORTE GENERAL -->
                    <div *ngIf="reporteActual === 'general'" id="reporte-general">
                        <h3 class="mb-4">Reporte General - {{ mesActual }}</h3>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">
                                    <i class="bi bi-cash-coin"></i> Resumen Financiero
                                </h5>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Total Gastos Activos:</span>
                                        <strong class="text-danger">${{ resumen.totalGastos | number:'1.0-0' }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Total Recaudado:</span>
                                        <strong class="text-success">${{ resumen.totalRecaudado | number:'1.0-0' }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Pendiente:</span>
                                        <strong class="text-warning">${{ resumen.pendiente | number:'1.0-0' }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Balance:</span>
                                        <strong [ngClass]="getBalanceClase()">
                                            ${{ resumen.balance | number:'1.0-0' }}
                                        </strong>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">
                                    <i class="bi bi-graph-up"></i> Estadísticas
                                </h5>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Total Residentes:</span>
                                        <strong>{{ estadisticas.totalResidentes }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Casas al Día:</span>
                                        <strong class="text-info">{{ estadisticas.casasAlDia }} de 13</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Tasa de Pago:</span>
                                        <strong class="text-success">{{ estadisticas.tasaPago }}%</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Gastos Activos:</span>
                                        <strong>{{ gastosActivos.length }}</strong>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <h5 class="text-primary mt-4 mb-3">
                            <i class="bi bi-trophy"></i> Top 5 Gastos Más Altos
                        </h5>
                        <div *ngIf="top5Gastos.length === 0" class="alert alert-info">
                            No hay gastos para mostrar.
                        </div>
                        <table class="table table-sm table-hover" *ngIf="top5Gastos.length > 0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Concepto</th>
                                    <th>Categoría</th>
                                    <th class="text-end">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let gasto of top5Gastos; let i = index">
                                    <td>{{ i + 1 }}</td>
                                    <td>{{ gasto.concepto }}</td>
                                    <td><span class="badge bg-primary">{{ gasto.categoria }}</span></td>
                                    <td class="text-end fw-bold">${{ gasto.monto | number:'1.0-0' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
